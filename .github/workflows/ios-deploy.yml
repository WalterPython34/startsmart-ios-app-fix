name: Deploy iOS App

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install dependencies
      run: npm install

    - name: Setup iOS
      run: |
        npm run ios:add
        npm run ios:sync

    - name: Configure Team ID
      run: |
        python3 -c "
        import re
        with open('ios/App/App.xcodeproj/project.pbxproj', 'r') as f:
            content = f.read()
        
        # Replace PRODUCT_BUNDLE_IDENTIFIER lines with DEVELOPMENT_TEAM + PRODUCT_BUNDLE_IDENTIFIER
        pattern = r'(\s+)PRODUCT_BUNDLE_IDENTIFIER = ai\.nextax\.startsmart;'
        replacement = r'\1DEVELOPMENT_TEAM = NKG2BDUB85;\n\1PRODUCT_BUNDLE_IDENTIFIER = ai.nextax.startsmart;'
        content = re.sub(pattern, replacement, content)
        
        with open('ios/App/App.xcodeproj/project.pbxproj', 'w') as f:
            f.write(content)
        "

    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.2'
        bundler-cache: true
        working-directory: ios/App

    - name: Create Fastfile
      run: |
        mkdir -p ios/App/fastlane
        cat > ios/App/fastlane/Fastfile << 'EOF'
        default_platform(:ios)

        platform :ios do
          lane :beta do
            build_app(workspace: "App.xcworkspace", scheme: "App", configuration: "Release", export_method: "app-store")
            upload_to_testflight(api_key: { key_id: ENV["APP_STORE_CONNECT_API_KEY_ID"], issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"], key_filepath: ENV["APP_STORE_CONNECT_API_KEY_PATH"] }, skip_waiting_for_build_processing: true)
          end
        end
        EOF

    - name: Create Gemfile
      run: |
        cat > ios/App/fastlane/Gemfile << 'EOF'
        source "https://rubygems.org"
        gem "fastlane"
        EOF

    - name: Deploy
      env:
        APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
        APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        APP_STORE_CONNECT_API_KEY_PATH: ~/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}.p8
        TEAM_ID: ${{ secrets.TEAM_ID }}
      run: |
        mkdir -p ~/private_keys
        echo "${{ secrets.APP_STORE_CONNECT_API_KEY }}" | base64 --decode > ~/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}.p8
        cd ios/App
        bundle exec fastlane ios beta
